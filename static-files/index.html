<!DOCTYPE html>
<meta charset="utf-8">
<title>Mozilla Mobile Phonebook</title>
<style>
div#templates {
  display: none;
}
</style>
<script src="jquery.min.js"></script>
<script>
function showPeople(people) {
  var list = $('ul#results');
  var pages = $('div#detail-pages');

  list.empty();
  pages.empty();

  people.forEach(function(person) {
    var item = $('<li></li>');
    var link = $('<a></a>');
    item.append(link);
    link.attr('href', '#' + person.email);
    link.text(person.name);
    list.append(item);

    var page = $('#templates div.detail').clone();
    page.attr('id', person.email);
    page.find('h1').text(person.name);
    page.find('.email').attr('href', 'mailto:' + person.email)
                       .text(person.email);
    page.find('.title').text(person.title);
    if (person.thumbnail) {
      var img = $('<img></img>');
      img.attr('src', 'images/people/' + person.email + '.jpg');
      page.find('.photo').append(img);
    } else
      page.find('.photo').remove();
    if (person.ims) {
      if (typeof(person.ims) == 'string')
        person.ims = [person.ims];
      person.ims.forEach(function(im) {
        var item = $('<li></li>');
        item.text(im);
        page.find('.ims').append(item);
      });
    } else
      page.find('.ims').remove();
    if (person.phones) {
      if (typeof(person.phones) == 'string')
        person.phones = [person.phones];
      person.phones.forEach(function(phone) {
        var item = $('<li></li>');
        item.text(phone);
        page.find('.phones').append(item);
      });
    } else
      page.find('.phones').remove();

    pages.append(page);

    // This is a weird thing we need to do in order for the new page
    // to exist and be linkable.
    page.attr('data-url', page.attr('id')).page();
  });

  list.data('listview').refresh();
}

function filterPeople(people, query) {
  var filtered = [];
  var regexp = new RegExp(query, 'i');
  people.forEach(function(person) {
    if (regexp.test(person.name) || regexp.test(person.email) ||
        regexp.test(person.title))
      filtered.push(person);
  });
  return filtered;
}

function onLoadPeople(people) {
  // TODO: Detail pages can't currently be bookmarked.
  $(window).ready(function() {
    var timerID = null;
    var lastQuery = "";
    
    // TODO: We currently need to bind this live, because
    // jQuery Mobile will destroy the element and recreate
    // it when it widget-ifies the markup at load time, or at least will
    // unbind all static handlers on it. Ideally, we should
    // be able to wait until widget-ification occurs and then
    // bind statically, or somesuch.
    $('input#search').live("keyup", function(event) {
      var input = $(this);
      if (timerID != null)
        clearTimeout(timerID);
      timerID = setTimeout(function() {
        var query = input.val();
        if (query == lastQuery)
          return;
        lastQuery = query;
        var filteredPeople = [];
        if (query.length > 2)
          filteredPeople = filterPeople(people, query);
        showPeople(filteredPeople);
        clearTimeout(timerID);
        timerID = null;
      }, 500);
    });
  });
}
</script>
<script src="load-people.js"></script>
<script src="jquery.mobile-1.0a4.min.js"></script>
<style>
@import url('jquery.mobile-1.0a4.min.css');
</style>
<div data-role="page">
  <div data-role="header">
    <h1>Mozilla Mobile Phonebook</h1>
  </div>
  <div data-role="content">
    <!-- TODO: This should be the width of the whole page. -->
    <input type="search" id="search" placeholder="Search for a person" value="" />
    <!-- TODO: Style this using CSS instead of two linebreaks. -->
    <br><br>
    <ul data-role="listview" data-theme="g" id="results"></ul>
  </div>
</div>
<div id="detail-pages"></div>
<div id="templates">
  <div data-role="page" class="detail">
    <div data-role="header">
      <h1></h1>
    </div>
    <div data-role="content">
      <div class="photo"></div>
      <div class="title"></div>
      <div class="email-container"><a class="email"></a></div>
      <ul class="ims"></ul>
      <ul class="phones"></ul>
    </div>
  </div>
</div>
